<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Reloj de Arena Digital</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .title {
            color: white;
            font-size: 2rem;
            margin-bottom: 2rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .hourglass-container {
            position: relative;
            width: 200px;
            height: 300px;
            margin: 0 auto 2rem;
            transform: scale(1);
            transition: transform 0.3s ease;
        }

        .hourglass-container.running {
            transform: scale(1.05);
        }

        .hourglass {
            width: 100%;
            height: 100%;
            position: relative;
            background: linear-gradient(45deg, #8B4513, #D2691E);
            border-radius: 20px;
            box-shadow: 
                0 10px 30px rgba(0,0,0,0.3),
                inset 0 2px 10px rgba(255,255,255,0.2);
        }

        .hourglass::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: #8B4513;
            clip-path: polygon(0 0, 100% 0, 50% 100%);
            z-index: 3;
        }

        .hourglass::after {
            content: '';
            position: absolute;
            top: calc(50% + 10px);
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: #8B4513;
            clip-path: polygon(50% 0, 0 100%, 100% 100%);
            z-index: 3;
        }

        .sand-container {
            position: absolute;
            width: 140px;
            height: 120px;
            left: 50%;
            transform: translateX(-50%);
        }

        .sand-container.top {
            top: 20px;
        }

        .sand-container.bottom {
            bottom: 20px;
        }

        .sand {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(180deg, #FFD700, #FFA500);
            border-radius: 0 0 10px 10px;
            transition: height 0.1s linear;
        }

        .sand-container.top .sand {
            top: 0;
            bottom: auto;
            border-radius: 10px 10px 0 0;
        }

        .sand-stream {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 0;
            background: linear-gradient(180deg, #FFD700, #FFA500);
            z-index: 2;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sand-stream.active {
            opacity: 1;
            animation: sandFlow 2s infinite linear;
        }

        @keyframes sandFlow {
            0%, 100% { height: 50px; }
            50% { height: 60px; }
        }

        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.9);
            color: #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 100px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn.secondary {
            background: linear-gradient(45deg, #f44336, #da190b);
            color: white;
        }

        .btn.tertiary {
            background: linear-gradient(45deg, #2196F3, #0b7dda);
            color: white;
        }

        .time-display {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .time-input {
            margin-bottom: 2rem;
        }

        .time-input input {
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            font-size: 1rem;
            text-align: center;
            width: 150px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            width: 0%;
            border-radius: 3px;
            transition: width 0.1s linear;
        }

        @media (max-width: 480px) {
            .title {
                font-size: 1.5rem;
            }
            
            .hourglass-container {
                width: 160px;
                height: 240px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 200px;
            }
        }

        .particles {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #FFD700;
            border-radius: 50%;
            opacity: 0;
        }

        .particle.active {
            animation: particleFall 1s linear infinite;
        }

        @keyframes particleFall {
            0% {
                transform: translateY(-20px);
                opacity: 1;
            }
            100% {
                transform: translateY(40px);
                opacity: 0;
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            }
            50% {
                transform: scale(1.05);
                text-shadow: 0 4px 20px rgba(255,255,255,0.8);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">‚è≥ Reloj de Arena</h1>
        
        <div class="hourglass-container" id="hourglassContainer">
            <div class="hourglass">
                <div class="sand-container top">
                    <div class="sand" id="topSand"></div>
                </div>
                <div class="sand-container bottom">
                    <div class="sand" id="bottomSand"></div>
                </div>
                <div class="sand-stream" id="sandStream"></div>
                <div class="particles" id="particles">
                    <div class="particle"></div>
                    <div class="particle"></div>
                    <div class="particle"></div>
                </div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="time-display" id="timeDisplay">01:00</div>

        <div class="time-input">
            <input type="number" id="timeInput" min="1" max="60" value="1" placeholder="Minutos"> minutos
        </div>

        <div class="controls">
            <button class="btn primary" id="playBtn">‚ñ∂Ô∏è Iniciar</button>
            <button class="btn secondary" id="resetBtn">üîÑ Reiniciar</button>
            <button class="btn tertiary" id="pauseBtn" style="display: none;">‚è∏Ô∏è Pausar</button>
            <button class="btn" id="testSoundBtn">üîî Probar Sonido</button>
        </div>
    </div>

    <script>
        class HourglassTimer {
            constructor() {
                this.totalTime = 60; // 1 minuto por defecto
                this.remainingTime = this.totalTime;
                this.isRunning = false;
                this.isPaused = false;
                this.interval = null;
                this.audioContext = null;
                this.audioInitialized = false;
                
                this.initElements();
                this.bindEvents();
                this.updateDisplay();
                this.initAudio();
            }

            initElements() {
                this.timeDisplay = document.getElementById('timeDisplay');
                this.timeInput = document.getElementById('timeInput');
                this.playBtn = document.getElementById('playBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.resetBtn = document.getElementById('resetBtn');
                this.testSoundBtn = document.getElementById('testSoundBtn');
                this.topSand = document.getElementById('topSand');
                this.bottomSand = document.getElementById('bottomSand');
                this.sandStream = document.getElementById('sandStream');
                this.progressFill = document.getElementById('progressFill');
                this.hourglassContainer = document.getElementById('hourglassContainer');
                this.particles = document.querySelectorAll('.particle');
                this.title = document.querySelector('.title');
            }

            bindEvents() {
                this.playBtn.addEventListener('click', () => {
                    this.initAudioContext();
                    this.start();
                });
                this.pauseBtn.addEventListener('click', () => this.pause());
                this.resetBtn.addEventListener('click', () => this.reset());
                this.testSoundBtn.addEventListener('click', () => {
                    this.initAudioContext();
                    this.playCompletionSound();
                });
                this.timeInput.addEventListener('change', (e) => this.setTime(e.target.value));
                
                // Inicializar audio en el primer toque/click (requerido por iOS)
                document.addEventListener('touchstart', () => this.initAudioContext(), { once: true });
                document.addEventListener('click', () => this.initAudioContext(), { once: true });
            }

            setTime(minutes) {
                if (!this.isRunning) {
                    this.totalTime = Math.max(1, Math.min(60, parseInt(minutes) || 1)) * 60;
                    this.remainingTime = this.totalTime;
                    this.updateDisplay();
                    this.updateSand();
                }
            }

            start() {
                if (this.isPaused) {
                    this.resume();
                    return;
                }

                this.isRunning = true;
                this.isPaused = false;
                this.playBtn.style.display = 'none';
                this.pauseBtn.style.display = 'inline-block';
                this.hourglassContainer.classList.add('running');
                this.sandStream.classList.add('active');
                this.startParticles();

                // Reproducir sonido de inicio (una sola campanada)
                this.playStartSound();

                this.interval = setInterval(() => {
                    this.remainingTime--;
                    this.updateDisplay();
                    this.updateSand();
                    this.updateProgress();

                    if (this.remainingTime <= 0) {
                        this.complete();
                    }
                }, 1000);
            }

            pause() {
                this.isPaused = true;
                this.isRunning = false;
                clearInterval(this.interval);
                this.playBtn.style.display = 'inline-block';
                this.playBtn.textContent = '‚ñ∂Ô∏è Continuar';
                this.pauseBtn.style.display = 'none';
                this.sandStream.classList.remove('active');
                this.stopParticles();
                this.hourglassContainer.classList.remove('running');
            }

            resume() {
                this.start();
            }

            reset() {
                this.isRunning = false;
                this.isPaused = false;
                clearInterval(this.interval);
                this.remainingTime = this.totalTime;
                
                this.playBtn.style.display = 'inline-block';
                this.playBtn.textContent = '‚ñ∂Ô∏è Iniciar';
                this.pauseBtn.style.display = 'none';
                this.sandStream.classList.remove('active');
                this.stopParticles();
                this.hourglassContainer.classList.remove('running');
                
                this.updateDisplay();
                this.updateSand();
                this.updateProgress();
            }

            complete() {
                this.isRunning = false;
                clearInterval(this.interval);
                this.playBtn.style.display = 'inline-block';
                this.playBtn.textContent = '‚ñ∂Ô∏è Iniciar';
                this.pauseBtn.style.display = 'none';
                this.sandStream.classList.remove('active');
                this.stopParticles();
                this.hourglassContainer.classList.remove('running');

                // Reproducir sonido de campanillas
                this.playCompletionSound();

                // Vibraci√≥n en dispositivos m√≥viles
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }

                // Notificaci√≥n visual (sin alert)
                document.body.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)';
                setTimeout(() => {
                    document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }, 2000);

                // Cambiar temporalmente el t√≠tulo
                const originalTitle = this.title.textContent;
                this.title.textContent = 'üéâ ¬°Tiempo Completado! üéâ';
                this.title.style.animation = 'pulse 1s infinite';
                
                setTimeout(() => {
                    this.title.textContent = originalTitle;
                    this.title.style.animation = '';
                }, 3000);
            }

            updateDisplay() {
                const minutes = Math.floor(this.remainingTime / 60);
                const seconds = this.remainingTime % 60;
                this.timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            updateSand() {
                const progress = (this.totalTime - this.remainingTime) / this.totalTime;
                const topHeight = (1 - progress) * 100;
                const bottomHeight = progress * 100;

                this.topSand.style.height = `${topHeight}%`;
                this.bottomSand.style.height = `${bottomHeight}%`;
            }

            updateProgress() {
                const progress = ((this.totalTime - this.remainingTime) / this.totalTime) * 100;
                this.progressFill.style.width = `${progress}%`;
            }

            startParticles() {
                this.particles.forEach((particle, index) => {
                    setTimeout(() => {
                        particle.classList.add('active');
                    }, index * 200);
                });
            }

            initAudio() {
                // Intentar inicializar el contexto de audio
                this.initAudioContext();
            }

            initAudioContext() {
                if (this.audioInitialized) return;
                
                try {
                    // Crear contexto de audio
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // iOS requiere que el contexto se "resume" despu√©s de una interacci√≥n del usuario
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume().then(() => {
                            console.log('Audio context resumed');
                            this.audioInitialized = true;
                        }).catch(e => {
                            console.log('Error resuming audio context:', e);
                        });
                    } else {
                        this.audioInitialized = true;
                    }
                    
                    // Reproducir un sonido silencioso para "despertar" el audio en iOS
                    this.playTestSound();
                    
                } catch (error) {
                    console.log('Audio no disponible:', error);
                    this.audioContext = null;
                }
            }

            playTestSound() {
                if (!this.audioContext) return;
                
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(440, this.audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0, this.audioContext.currentTime); // Silencioso
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + 0.1);
                } catch (error) {
                    console.log('Error en test sound:', error);
                }
            }

            playStartSound() {
                if (!this.audioContext || !this.audioInitialized) {
                    console.log('Audio no inicializado para sonido de inicio');
                    return;
                }

                try {
                    // Asegurar que el contexto est√© activo
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }

                    // Reproducir una sola campanada de inicio (nota media)
                    this.playBellNote(659.25, 1.2); // E5 - nota alegre de inicio

                } catch (error) {
                    console.log('Error reproduciendo sonido de inicio:', error);
                }
            }

            playCompletionSound() {
                if (!this.audioContext || !this.audioInitialized) {
                    console.log('Audio no inicializado');
                    return;
                }

                try {
                    // Asegurar que el contexto est√© activo
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }

                    // Definir las notas de campanilla (en Hz) - melod√≠a alegre
                    const bellNotes = [
                        523.25, // C5
                        659.25, // E5  
                        783.99, // G5
                        1046.50, // C6
                        783.99, // G5
                        659.25, // E5
                        523.25  // C5
                    ];

                    // Reproducir cada nota secuencialmente
                    bellNotes.forEach((frequency, index) => {
                        setTimeout(() => {
                            this.playBellNote(frequency, 0.8);
                        }, index * 200);
                    });

                    // Tocar campanadas finales m√°s fuertes
                    setTimeout(() => {
                        this.playBellNote(1046.50, 1.5); // C6
                    }, bellNotes.length * 200);

                    setTimeout(() => {
                        this.playBellNote(1046.50, 1.5); // C6
                    }, (bellNotes.length * 200) + 300);

                } catch (error) {
                    console.log('Error reproduciendo campanillas:', error);
                }
            }

            playBellNote(frequency, duration) {
                if (!this.audioContext || !this.audioInitialized) return;

                try {
                    // Crear oscilador para la nota fundamental
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    // Crear arm√≥nicos para sonido m√°s realista de campanilla
                    const oscillator2 = this.audioContext.createOscillator();
                    const gainNode2 = this.audioContext.createGain();
                    
                    const oscillator3 = this.audioContext.createOscillator();
                    const gainNode3 = this.audioContext.createGain();

                    // Configurar osciladores
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                    
                    oscillator2.type = 'sine';
                    oscillator2.frequency.setValueAtTime(frequency * 2, this.audioContext.currentTime); // Octava
                    
                    oscillator3.type = 'sine';
                    oscillator3.frequency.setValueAtTime(frequency * 3, this.audioContext.currentTime); // Quinta

                    // Configurar envolvente (ataque r√°pido, decaimiento lento como campanilla)
                    const now = this.audioContext.currentTime;
                    
                    gainNode.gain.setValueAtTime(0, now);
                    gainNode.gain.linearRampToValueAtTime(0.3, now + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);
                    
                    gainNode2.gain.setValueAtTime(0, now);
                    gainNode2.gain.linearRampToValueAtTime(0.15, now + 0.01);
                    gainNode2.gain.exponentialRampToValueAtTime(0.001, now + duration);
                    
                    gainNode3.gain.setValueAtTime(0, now);
                    gainNode3.gain.linearRampToValueAtTime(0.1, now + 0.01);
                    gainNode3.gain.exponentialRampToValueAtTime(0.001, now + duration);

                    // Conectar nodos
                    oscillator.connect(gainNode);
                    oscillator2.connect(gainNode2);
                    oscillator3.connect(gainNode3);
                    
                    gainNode.connect(this.audioContext.destination);
                    gainNode2.connect(this.audioContext.destination);
                    gainNode3.connect(this.audioContext.destination);

                    // Iniciar y detener osciladores
                    oscillator.start(now);
                    oscillator2.start(now);
                    oscillator3.start(now);
                    
                    oscillator.stop(now + duration);
                    oscillator2.stop(now + duration);
                    oscillator3.stop(now + duration);

                } catch (error) {
                    console.log('Error reproduciendo nota:', error);
                }
            }

            stopParticles() {
                this.particles.forEach(particle => {
                    particle.classList.remove('active');
                });
            }
        }

        // Inicializar la aplicaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            new HourglassTimer();
        });

        // Prevenir zoom en iOS
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });

        // Prevenir scroll cuando se toca
        document.addEventListener('touchmove', function(e) {
            if (e.target.tagName !== 'INPUT') {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>